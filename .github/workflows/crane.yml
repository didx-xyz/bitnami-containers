name: Copy tags from Bitnami to GHCR

on:
  workflow_dispatch:
    inputs:
      containers:
        description: "Comma-separated list of container names to sync (e.g: keycloak, nats, valkey)"
        required: true
        type: string
      legacy:
        description: "Whether or not to sync from Bitnami Legacy (default: true)"
        required: false
        default: true
        type: boolean

permissions: {}

jobs:
  generate-matrix:
    name: Generate matrix
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Generate matrix
        id: generate-matrix
        env:
          CONTAINERS_INPUT: ${{ github.event.inputs.containers }}
        run: |
          # Parse comma-separated input into array
          containers_input="${CONTAINERS_INPUT}"
          echo "Input containers: $containers_input"

          # Convert comma-separated string to JSON array
          # Remove spaces around commas and convert to JSON
          containers_json=$(echo "$containers_input" | sed 's/[[:space:]]*,[[:space:]]*/\n/g' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//' | jq -R -s -c 'split("\n") | map(select(length > 0)) | map({"image": .})')

          echo "Generated matrix JSON: '$containers_json'"

          echo "matrix=$containers_json" >> $GITHUB_OUTPUT

  crane:
    name: Copy ${{ matrix.image }}
    runs-on: ubuntu-24.04
    needs: generate-matrix
    permissions:
      packages: write
    strategy:
      fail-fast: false
      max-parallel: 10
      matrix:
        # Matrix is generated dynamically from user input
        # Example: [{"image": "keycloak"}, {"image": "nats"}, {"image": "valkey"}]
        include: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.5.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      - uses: imjasonh/setup-crane@31b88efe9de28ae0ffa220711af4b60be9435f6e # v0.4
      - name: Copy ${{ matrix.image }}
        env:
          IMAGE: ${{ matrix.image }}
          REPO: ${{ github.event.inputs.legacy == 'true' && 'docker.io/bitnamilegacy' || 'docker.io/bitnami' }}
        run: |-
          crane ls ${REPO}/${IMAGE} | grep -v '^sha256-' | parallel --will-cite -j4 --no-run-if-empty \
            'crane copy --no-clobber ${REPO}/${IMAGE}:{} ghcr.io/${{ github.repository_owner }}/bitnami-oss/${{ matrix.image }}:{} || echo "::warning::Failed to copy ${REPO}/${IMAGE}:{}"'
